#!/bin/bash

# A script that runs frontend build in a row and compare the hashes of the generated files.
# Exit if a difference is detected.

DIR=tmp

if [ ! -d "$DIR" ]; then
  mkdir "$DIR"
fi

for ((n = 0; n < 100; n++)); do
  npm run build && find frontend/public -type f -exec sha256sum {} \; >"$DIR/sha256-batch${n}.txt"

  if ((n > 0)); then
    previous=$((n - 1))
    file1="sha256-batch${n}.txt"
    file2="sha256-batch${previous}.txt"

    if cmp -s "$DIR/$file1" "$DIR/$file2"; then
      continue
    else
      printf 'The file "%s" is different from "%s".\n' "$file1" "$file2"
      exit
    fi
  fi
done

echo 'No difference found.'
