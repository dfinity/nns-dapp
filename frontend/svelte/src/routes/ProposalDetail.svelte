<script lang="ts">
  import { onDestroy, onMount } from "svelte";
  import HeadlessLayout from "../lib/components/common/HeadlessLayout.svelte";
  import Spinner from "../lib/components/ui/Spinner.svelte";
  import {
    routePathProposalId,
    loadProposal,
  } from "../lib/services/proposals.services";
  import { routeStore } from "../lib/stores/route.store";
  import {
    AppPath,
    SHOW_PROPOSALS_ROUTE,
  } from "../lib/constants/routes.constants";
  import type { ProposalInfo } from "@dfinity/nns";
  import ProposalDetailCard from "../lib/components/proposal-detail/ProposalDetailCard/ProposalDetailCard.svelte";
  import VotesCard from "../lib/components/proposal-detail/VotesCard.svelte";
  import VotingCard from "../lib/components/proposal-detail/VotingCard/VotingCard.svelte";
  import IneligibleNeuronsCard from "../lib/components/proposal-detail/IneligibleNeuronsCard.svelte";
  import { i18n } from "../lib/stores/i18n";
  import { listNeurons } from "../lib/services/neurons.services";
  import {
    definedNeuronsStore,
    neuronsStore,
  } from "../lib/stores/neurons.store";
  import {
    proposalIdStore,
    proposalInfoStore,
  } from "../lib/stores/proposals.store";
  import { isRoutePath } from "../lib/utils/app-path.utils";

  const neuronsStoreReady = (): boolean => {
    // We consider the neurons store as ready if it has been initialized once. Subsequent changes that happen after vote or other functions are handled with the busy store.
    // This to avoid the display of a spinner within the page and another spinner over it (the busy spinner) when the user vote is being processed.
    if (neuronsReady) {
      return true;
    }

    return (
      $neuronsStore.neurons !== undefined && $neuronsStore.certified === true
    );
  };

  let neuronsReady = false;
  $: $neuronsStore, (neuronsReady = neuronsStoreReady());

  onMount(async () => {
    if (!SHOW_PROPOSALS_ROUTE) {
      window.location.replace(`/${window.location.hash}`);
      return;
    }

    // We query the neurons only if they were not yet fully fetched - i.e. never initialized
    if (neuronsStoreReady()) {
      return;
    }

    await listNeurons();
  });

  const unsubscribeRouteStore = routeStore.subscribe(
    async ({ path: routePath }) => {
      if (!isRoutePath({ path: AppPath.ProposalDetail, routePath })) {
        return;
      }
      const proposalId = routePathProposalId(routePath);

      if (proposalId === undefined) {
        // Navigate to the proposal list in no proposalId found
        routeStore.replace({ path: AppPath.Proposals });
        return;
      }

      proposalIdStore.set(proposalId);
    }
  );

  const onError = (certified: boolean) => {
    // Ignore "application payload size (X) cannot be larger than Y" error thrown by update calls
    if (certified) {
      return;
    }
    routeStore.replace({ path: AppPath.Proposals });
  };

  const unsubscribeProposalIdStore = proposalIdStore.subscribe((proposalId) => {
    if (proposalId === undefined || proposalId === $proposalInfoStore?.id) {
      return;
    }
    loadProposal({
      proposalId,
      setProposal: (proposalInfo: ProposalInfo) =>
        proposalInfoStore.set(proposalInfo),
      handleError: onError,
      silentUpdateErrorMessages: true,
    });
  });

  const goBack = () => {
    routeStore.navigate({
      path: AppPath.Proposals,
    });
  };

  onDestroy(() => {
    unsubscribeRouteStore();
    unsubscribeProposalIdStore();
    proposalIdStore.reset();
  });
</script>

{#if SHOW_PROPOSALS_ROUTE}
  <HeadlessLayout on:nnsBack={goBack} showFooter={false}>
    <svelte:fragment slot="header"
      >{$i18n.proposal_detail.title}</svelte:fragment
    >

    <section>
      {#if $proposalInfoStore}
        <ProposalDetailCard proposalInfo={$proposalInfoStore} />

        {#if neuronsReady}
          <VotesCard proposalInfo={$proposalInfoStore} />
          <VotingCard proposalInfo={$proposalInfoStore} />
          <IneligibleNeuronsCard
            proposalInfo={$proposalInfoStore}
            neurons={$definedNeuronsStore}
          />
        {:else}
          <div class="loader">
            <div class="spinner">
              <Spinner />
            </div>

            <span><small>{$i18n.proposal_detail.loading_neurons}</small></span>
          </div>
        {/if}
      {:else}
        <Spinner />
      {/if}
    </section>
  </HeadlessLayout>
{/if}

<style lang="scss">
  .loader {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  .spinner {
    position: relative;
    padding: var(--padding-2x) 0;
  }
</style>
