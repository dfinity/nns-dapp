# App deployments are non-production deployments to mainnet.  They are public, can be used as staging, but e.g. funds are real.
name: Deploy to app
on:
  schedule:
    # Run every Tuesday:
    #   summer: 7pm Zurich time
    #   winter: 8pm Zurich time
    - cron: '0 18 * * 2'
  workflow_dispatch:
  push:
    branches:
      - "deploy-to-app"
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  deploy-app:
    # TODO: When we use a pre-built release, switch to a smaller runner.
    runs-on: ubuntu-latest-m
    timeout-minutes: 60
    env:
      NNS_DAPP_APP_SUBNET_CANISTER_ID: "xnjld-hqaaa-aaaal-qb56q-cai"
      SNS_AGGREGATOR_APP_SUBNET_CANISTER_ID: "xnjld-hqaaa-aaaal-qb56q-cai"
      DFX_NETWORK: ic
    steps:
      - name: Checkout nns-dapp
        uses: actions/checkout@v3
        # TODO: This builds, it doesn't use a release.  We probably want at least the option of using releases.
      - name: Get versions
        id: tool_versions
        run: echo "dfx=$(jq -r .dfx dfx.json)" >> "$GITHUB_OUTPUT"
      - name: Set credentials
        #        uses: aviate-labs/setup-dfx@v0.2.3
        #with:
        #  dfx-version: ${{ steps.tool_versions.outputs.dfx }}
        #  dfx-disable-encryption: true
        run: |
          DFX_VERSION="$(jq -r .dfx dfx.json)" sh -ci "$(curl -fsSL https://sdk.dfinity.org/install.sh)"
          printf "%s" "${{ secrets.DFX_IDENTITY_PEM }}" | dfx identity import --storage-mode=plaintext ci /dev/stdin
          dfx identity use ci
        env:
          DFX_IDENTITY_PEM: ${{ secrets.DFX_IDENTITY_PEM }}
      - name: Get SNS scripts
        uses: actions/checkout@v3
        with:
          repository: 'dfinity/snsdemo'
          path: 'snsdemo'
          # Version from 2023-06-06 with dfx v0.14.1
          ref: '0e61f618018db099a01b1686535fff8eff980d1c'
      - name: Set up SNS scripts
        run: |
          : Install more
          sudo apt-get update -yy && sudo apt-get install -yy moreutils
          : Add scripts to the path
          echo "$PWD/snsdemo/bin" >> $GITHUB_PATH
      - name: Verify identity
        run: |
          dfx identity whoami
          dfx identity get-principal
      - name: Build wasms
        uses: ./.github/actions/build_nns_dapp # Builds sns_aggregator as well.
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Deploy nns-dapp
        run: |
          DFX_NETWORK="$DFX_NETWORK" jq 'del(.canisters.internet_identity.remote.id[env.DFX_NETWORK])' dfx.json | sponge dfx.json
          dfx-canister set-id --network "$DFX_NETWORK" --canister_name nns-dapp --canister_id "$NNS_DAPP_APP_SUBNET_CANISTER_ID"
          scripts/nns-dapp/split-assets
          dfx canister install --network "$DFX_NETWORK" nns-dapp --argument "$(cat out/nns-dapp-arg-mainnet.did)" --wasm out/nns-dapp_noassets.wasm
          ./scripts/nns-dapp/upload-asset-tarball --network "$DFX_NETWORK" --chunk out/chunks/assets.xaa.tar.xz
          ./scripts/nns-dapp/upload-asset-tarball --network "$DFX_NETWORK" --chunk out/chunks/assets.xab.tar.xz
