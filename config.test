#!/usr/bin/env bash
set -euo pipefail

JSON_CONFIG="deployment-config.json"
ENV_CONFIG="frontend/.env"
arg_config() {
  echo "nns-dapp-arg-${DFX_NETWORK}.did"
}

clean_config() {
  ALL_CONFIG=("$JSON_CONFIG" "$ENV_CONFIG" "$(arg_config)")
  rm -f "${ALL_CONFIG[@]}"
}

(
  echo "Stability test: Verifies that mainnet parameters have not changed unintentionally."
  echo "(If the mainnet parameters have changed intentionally, please update the values in this test.)"

  DFX_NETWORK=mainnet
  clean_config
  export DFX_NETWORK
  chronic ./config.sh
  json_diff="$(
    diff "$JSON_CONFIG" <(
      cat <<-EOF
		{
		  "API_HOST": "https://icp-api.io",
		  "CKBTC_INDEX_CANISTER_ID": "n5wcd-faaaa-aaaar-qaaea-cai",
		  "CKBTC_LEDGER_CANISTER_ID": "mxzaz-hqaaa-aaaar-qaada-cai",
		  "CKBTC_MINTER_CANISTER_ID": "mqygn-kiaaa-aaaar-qaadq-cai",
		  "CYCLES_MINTING_CANISTER_ID": "rkp4c-7iaaa-aaaaa-aaaca-cai",
		  "DFX_NETWORK": "mainnet",
		  "FEATURE_FLAGS": {
		    "ENABLE_CKBTC": true,
		    "ENABLE_CKTESTBTC": false,
		    "ENABLE_SNS_AGGREGATOR": true,
		    "ENABLE_SNS_VOTING": false
		  },
		  "FETCH_ROOT_KEY": false,
		  "GOVERNANCE_CANISTER_ID": "rrkah-fqaaa-aaaaa-aaaaq-cai",
		  "HOST": "https://icp-api.io",
		  "IDENTITY_SERVICE_URL": "https://identity.internetcomputer.org/",
		  "LEDGER_CANISTER_ID": "ryjl3-tyaaa-aaaaa-aaaba-cai",
		  "LEDGER_CANISTER_URL": "https://ryjl3-tyaaa-aaaaa-aaaba-cai.icp-api.io",
		  "OWN_CANISTER_ID": "qoctq-giaaa-aaaaa-aaaea-cai",
		  "OWN_CANISTER_URL": "https://nns.internetcomputer.org",
		  "ROBOTS": "<meta name=\"robots\" content=\"noindex, nofollow\" />",
		  "SNS_AGGREGATOR_URL": "https://3r4gx-wqaaa-aaaaq-aaaia-cai.icp0.io",
		  "STATIC_HOST": "https://icp0.io",
		  "TVL_CANISTER_ID": "ewh3f-3qaaa-aaaap-aazjq-cai",
		  "WASM_CANISTER_ID": "qaa6y-5yaaa-aaaaa-aaafa-cai"
		}
		EOF
    )
  )"
  [[ "${json_diff:-}" == "" ]] || {
    printf "ERROR: %s\n" "Unexpected difference in $JSON_CONFIG:"
    printf "%s\n" "$json_diff"
    exit 1
  } >&2

  env_diff="$(
    diff "$ENV_CONFIG" <(
      cat <<-EOF
		VITE_DFX_NETWORK=mainnet
		VITE_CYCLES_MINTING_CANISTER_ID=rkp4c-7iaaa-aaaaa-aaaca-cai
		VITE_WASM_CANISTER_ID=qaa6y-5yaaa-aaaaa-aaafa-cai
		VITE_GOVERNANCE_CANISTER_ID=rrkah-fqaaa-aaaaa-aaaaq-cai
		VITE_TVL_CANISTER_ID=ewh3f-3qaaa-aaaap-aazjq-cai
		VITE_LEDGER_CANISTER_ID=ryjl3-tyaaa-aaaaa-aaaba-cai
		VITE_LEDGER_CANISTER_URL=https://ryjl3-tyaaa-aaaaa-aaaba-cai.icp-api.io
		VITE_OWN_CANISTER_ID=qoctq-giaaa-aaaaa-aaaea-cai
		VITE_OWN_CANISTER_URL=https://nns.internetcomputer.org
		VITE_FETCH_ROOT_KEY=false
		VITE_FEATURE_FLAGS="{\"ENABLE_CKBTC\":true,\"ENABLE_CKTESTBTC\":false,\"ENABLE_SNS_AGGREGATOR\":true,\"ENABLE_SNS_VOTING\":false}"
		VITE_HOST=https://icp-api.io
		VITE_IDENTITY_SERVICE_URL=https://identity.internetcomputer.org/
		VITE_AGGREGATOR_CANISTER_URL=https://3r4gx-wqaaa-aaaaq-aaaia-cai.icp0.io
		VITE_CKBTC_LEDGER_CANISTER_ID=mxzaz-hqaaa-aaaar-qaada-cai
		VITE_CKBTC_MINTER_CANISTER_ID=mqygn-kiaaa-aaaar-qaadq-cai
		VITE_CKBTC_INDEX_CANISTER_ID=n5wcd-faaaa-aaaar-qaaea-cai
		EOF
    )
  )"
  [[ "${env_diff:-}" == "" ]] || {
    printf "ERROR: %s\n" "Unexpected difference in $ENV_CONFIG:"
    printf "%s\n" "$env_diff"
    exit 1
  } >&2

  arg_diff="$(
    diff "$(arg_config)" <(
      cat <<-EOF
		(opt record{
		  args = vec {
		    record{ 0="API_HOST"; 1="https://icp-api.io" };
		    record{ 0="CKBTC_INDEX_CANISTER_ID"; 1="n5wcd-faaaa-aaaar-qaaea-cai" };
		    record{ 0="CKBTC_LEDGER_CANISTER_ID"; 1="mxzaz-hqaaa-aaaar-qaada-cai" };
		    record{ 0="CKBTC_MINTER_CANISTER_ID"; 1="mqygn-kiaaa-aaaar-qaadq-cai" };
		    record{ 0="CYCLES_MINTING_CANISTER_ID"; 1="rkp4c-7iaaa-aaaaa-aaaca-cai" };
		    record{ 0="DFX_NETWORK"; 1="mainnet" };
		    record{ 0="FEATURE_FLAGS"; 1="{\"ENABLE_CKBTC\":true,\"ENABLE_CKTESTBTC\":false,\"ENABLE_SNS_AGGREGATOR\":true,\"ENABLE_SNS_VOTING\":false}" };
		    record{ 0="FETCH_ROOT_KEY"; 1="false" };
		    record{ 0="GOVERNANCE_CANISTER_ID"; 1="rrkah-fqaaa-aaaaa-aaaaq-cai" };
		    record{ 0="HOST"; 1="https://icp-api.io" };
		    record{ 0="IDENTITY_SERVICE_URL"; 1="https://identity.internetcomputer.org/" };
		    record{ 0="LEDGER_CANISTER_ID"; 1="ryjl3-tyaaa-aaaaa-aaaba-cai" };
		    record{ 0="LEDGER_CANISTER_URL"; 1="https://ryjl3-tyaaa-aaaaa-aaaba-cai.icp-api.io" };
		    record{ 0="OWN_CANISTER_ID"; 1="qoctq-giaaa-aaaaa-aaaea-cai" };
		    record{ 0="OWN_CANISTER_URL"; 1="https://nns.internetcomputer.org" };
		    record{ 0="ROBOTS"; 1="<meta name=\"robots\" content=\"noindex, nofollow\" />" };
		    record{ 0="SNS_AGGREGATOR_URL"; 1="https://3r4gx-wqaaa-aaaaq-aaaia-cai.icp0.io" };
		    record{ 0="STATIC_HOST"; 1="https://icp0.io" };
		    record{ 0="TVL_CANISTER_ID"; 1="ewh3f-3qaaa-aaaap-aazjq-cai" };
		    record{ 0="WASM_CANISTER_ID"; 1="qaa6y-5yaaa-aaaaa-aaafa-cai" };
		  };
		})
		EOF
    )
  )"
  [[ "${arg_diff:-}" == "" ]] || {
    printf "ERROR: %s\n" "Unexpected difference in $(arg_config):"
    printf "%s\n" "$arg_diff"
    exit 1
  } >&2

)

(
  echo "Network parameter is in config"
  for DFX_NETWORK in mainnet local; do
    clean_config
    DFX_NETWORK="$DFX_NETWORK" chronic ./config.sh
    : "Check value in JSON"
    JSON_NETWORK="$(jq -r .DFX_NETWORK "$JSON_CONFIG")"
    [[ "$DFX_NETWORK" == "$JSON_NETWORK" ]] || {
      printf "ERROR: %s\n" "Unexpected DFX_NETWORK value in $JSON_CONFIG:" \
        "Expected: $DFX_NETWORK" \
        "Actual:   $JSON_NETWORK"
      exit 1
    } >&2
    : "Check value in arg"
    ARG_NETWORK="$(idl2json <"$(arg_config)" | jq -r '.[0].args[]|select(.["0"] == "DFX_NETWORK")|.["1"]')"
    [[ "$DFX_NETWORK" == "$ARG_NETWORK" ]] || {
      printf "ERROR: %s\n" "Unexpected DFX_NETWORK value in $(arg_config):" \
        "Expected: $DFX_NETWORK" \
        "Actual:   $ARG_NETWORK"
      exit 1
    } >&2

  done

)
