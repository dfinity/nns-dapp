#!/usr/bin/env bash
tarfile_contents() {
  # Tarfile contents, excluding directories
  tar -Jtf "$1" | grep -vE '/$'
}

(
  echo "Chunks should contain all the original files"

  : "Get or create a .tar.xz file"
  original="$(mktemp ,original-XXXXXX)"
  if test -e out/assets.tar.xz; then
    cp out/assets.tar.xz "$toy_assets"
  else
    tar -cJf "$original" frontend
  fi

  : "Chunk the original"
  chunks_dir="$(mktemp -d ,chunks-XXXXXX)"
  scripts/nns-dapp/split-assets --assets "${original}" --out "$chunks_dir"

  : "Check that the list of files is the same"
  diff <(tarfile_contents "$original" | sort) <(find "$chunks_dir" -type f | while read line; do tarfile_contents "$line"; done | sort) || {
    echo "ERROR: The list of files present in the chunks should be the same as that in the original, without duplicates or omissions."
    echo "Original:   $original"
    echo "Chunks dir: $chunks_dir"
    exit 1
  } >&2

  : "Check that the file contents are the same"
  original_unpacked="$(mktemp -d ,original-assets-XXXXXX)"
  tar -Jxf out/assets.tar.xz -C "$original_unpacked"
  chunks_unpacked="$(mktemp -d ,chunked-assets-XXXXXX)"
  find out/chunks/ -type f | xargs -I{} tar -Jxf {} -C "$chunks_unpacked"
  diff --recursive "$original_unpacked" "$chunks_unpacked" || {
    echo "ERROR: The contents of the chunked tarballs should match the contents of the original tarball"
    echo "Unpacked original: $original_unpacked"
    echo "Unpacked chunks:   $chunks_unpacked"
    exit 1
  } >&2

  : "Clean up"
  rm -fr "$original" "$chunks_dir" "$original_unpacked" "$chunks_unpacked"
)

echo "$(basename "$0") PASSED"
