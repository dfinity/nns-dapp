#!/usr/bin/env bash
set -xeuo pipefail

SOURCE_DIR="$(dirname "${BASH_SOURCE[0]}")"
SCRIPT="$SOURCE_DIR/past-changelog-test"
CHANGELOG="CHANGELOG-Nns-Dapp.md"

if ! "$SCRIPT"; then
  echo "Should have passed without additional changes." >&2
  exit 1
fi

# Writes stdin to the given file, but only after reading all of stdin.
# Polyfill because `sponge` is not available everywhere.
sponge() {
  local tmp_file
  tmp_file="$(mktemp)"
  cat >"$tmp_file"
  mv "$tmp_file" "$1"
}

awk '/## Proposal/ {if (!done) {print "* change above"; done=1}} 1' CHANGELOG-Nns-Dapp.md | sponge CHANGELOG-Nns-Dapp.md
if ! "$SCRIPT"; then
  echo "Should have passed with change above most recent release." >&2
  exit 1
fi
git checkout CHANGELOG-Nns-Dapp.md

awk '/## Proposal/ {if (!done) {print; print "* change below"; done=1; next}} 1' CHANGELOG-Nns-Dapp.md | sponge CHANGELOG-Nns-Dapp.md
if "$SCRIPT"; then
  echo "Should have failed with change below most recent release." >&2
  exit 1
fi
git checkout CHANGELOG-Nns-Dapp.md

sed '199i\
* changed on line 199
' CHANGELOG-Nns-Dapp.md | sponge CHANGELOG-Nns-Dapp.md
if "$SCRIPT"; then
  echo "Should have failed with change on line 199." >&2
  exit 1
fi
git checkout CHANGELOG-Nns-Dapp.md
